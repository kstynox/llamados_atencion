<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SENA 360 – Llamados de Atención</title>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --verde-sena: #39A900;
      --verde-oscuro: #2E7D00;
      --texto-principal:#111827;
      --texto-secundario:#4B5563;
      --gris-borde:#E5E7EB;
      --fondo:#F3F4F6;
      --blanco:#FFFFFF;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--fondo);
      color:var(--texto-principal);
    }

    header{
      background:#fff;
      padding:12px 20px 6px;
      border-bottom:6px solid #0f9b1a;
      box-shadow:0 1px 6px rgba(0,0,0,.06);
    }
    .header-content{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .header-left{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .header-left img{
      height:52px;
      width:auto;
    }
    .header-left-text{
      font-size:16px;
      font-weight:700;
      color:#0b3918;
    }
    .header-center{
      font-size:18px;
      font-weight:700;
      color:#0d7c1d;
      text-align:center;
    }
    .header-right{
      font-size:14px;
      color:#4b5563;
      text-align:right;
      white-space:nowrap;
    }

    .wrap{
      max-width:1250px;
      margin:18px auto 48px auto;
      padding:0 14px;
    }

    .card{
      background:var(--blanco);
      border:1px solid var(--gris-borde);
      border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
      overflow:hidden;
    }

    .card-header{
      padding:16px 18px;
      border-bottom:1px solid var(--gris-borde);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
    }
    .card-header h2{
      margin:0;
      font-size:18px;
      font-weight:900;
    }
    .card-header .sub{
      margin-top:6px;
      color:var(--texto-secundario);
      font-size:13px;
    }

    /* Pills */
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:#EEF2FF;
      color:#1E3A8A;
      border:1px solid rgba(30,58,138,.15);
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      white-space:nowrap;
      height:fit-content;
    }

    /* Acordeón */
    .acordeon{
      padding:16px 18px 18px 18px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .acordeon-item{
      border:0;
      border-radius:24px;
      overflow:hidden;
      background:#fff;
      box-shadow:0 20px 40px rgba(15,23,42,.12);
      transition: transform .3s ease, box-shadow .3s ease;
    }
    .acordeon-item:not(.open){
      border:1px solid rgba(15,23,42,.08);
      box-shadow:none;
    }
    .acordeon-item.open{
      transform: translateY(-4px);
      box-shadow:0 30px 60px rgba(15,23,42,.18);
    }
    .acordeon-header{
      width:100%;
      padding:18px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      background:transparent;
      border:none;
      outline:none;
      font-weight:900;
      font-size:16px;
      color:var(--texto-principal);
    }
    .acordeon-body{
      display:none;
      padding:32px;
      background:#fff;
    }
    .acordeon-item.open .acordeon-body{ display:block; }
    .hero-section{
      text-align:center;
      padding-bottom:24px;
    }
    .hero-icon{
      width:64px;
      height:64px;
      border-radius:50%;
      background:rgba(57,169,0,.12);
      margin:0 auto 14px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .hero-icon svg{
      width:28px;
      height:28px;
      fill:var(--verde-sena);
    }
    .hero-title{
      font-size:22px;
      font-weight:900;
      margin-bottom:6px;
    }
    .hero-sub{
      color:#6b7280;
      font-size:14px;
      line-height:1.6;
      max-width:440px;
      margin:0 auto;
    }
    .drop-zone{
      border:2px dashed rgba(15,23,42,.25);
      border-radius:20px;
      padding:32px;
      margin:0 auto 24px;
      max-width:620px;
      position:relative;
      cursor:pointer;
      transition:border .2s ease, box-shadow .2s ease;
    }
    .drop-zone:hover{
      border-color:rgba(57,169,0,.7);
      box-shadow:0 0 0 3px rgba(57,169,0,.15);
    }
    .drop-zone input{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      opacity:0;
      cursor:pointer;
    }
    .drop-zone--active{
      border-color:rgba(57,169,0,.9);
      box-shadow:0 0 0 4px rgba(57,169,0,.25);
    }
    .drop-content{
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:center;
      justify-content:center;
      font-size:16px;
      color:#0f172a;
      font-weight:600;
    }
    .drop-content small{
      font-size:12px;
      color:#6b7280;
      font-weight:400;
    }

    /* Inputs */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:900px){
      .grid{ grid-template-columns:1fr; }
    }

    label{
      display:block;
      font-size:12px;
      font-weight:900;
      color:#111827;
      margin-bottom:6px;
    }

    input[type="text"], input[type="file"], input[type="date"], input[type="datetime-local"], textarea{
      width:100%;
      border:1px solid var(--gris-borde);
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      outline:none;
      background:#fff;
    }
    textarea{ min-height:92px; resize:vertical; }

    .row{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .btn{
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      font-size:13px;
      background:var(--verde-sena);
      color:#fff;
      transition: transform .05s ease, background .12s ease;
    }
    .btn:hover{ background:var(--verde-oscuro); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background:#39A900;
    }
    .btn.secondary:hover{ background:#0B1220; }
    .btn.ghost{
      background:#fff;
      color:#0f3924;
      border:1px solid var(--gris-borde);
    }
    .btn.ghost:hover{ background:#F9FAFB; }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .note{
      color:var(--texto-secundario);
      font-size:12px;
      margin-top:6px;
      line-height:1.3;
    }

    .alert{
      display:none;
      border:1px solid rgba(220,38,38,.25);
      background:rgba(220,38,38,.06);
      color:#7F1D1D;
      padding:10px 12px;
      border-radius:12px;
      font-size:12px;
      font-weight:800;
      margin-top:10px;
    }
    .alert.show{ display:block; }

    .table-tools{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }
    .table-tools input{
      flex:1;
      min-width:220px;
      max-width:360px;
      border:1px solid var(--gris-borde);
      border-radius:12px;
      padding:8px 12px;
      font-size:13px;
      background:#fff;
    }
    .table-tools__hint{
      font-size:11px;
      color:var(--texto-secundario);
      white-space:nowrap;
    }
    th.sortable{
      cursor:pointer;
      user-select:none;
    }
    .sort-indicator{
      font-size:11px;
      margin-left:4px;
      opacity:.6;
    }

    /* Tabla */
    .table-wrap{
      overflow:auto;
      border:1px solid var(--gris-borde);
      border-radius:12px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:880px;
    }
    thead th{
      position:sticky;
      top:0;
      background:#39a900;
      color:#fff;
      font-size:12px;
      padding:10px 10px;
      text-align:left;
      white-space:nowrap;
    }
    thead th.reason-col span:first-child{
      display:block;
      white-space:normal;
      line-height:1.2;
    }
    thead th.name-col{
      min-width:240px;
      max-width:260px;
    }
    thead th.reason-col{
      min-width:90px;
      max-width:110px;
      text-align:center;
    }
    tbody td{
      border-top:1px solid var(--gris-borde);
      padding:10px 10px;
      font-size:12.5px;
      vertical-align:top;
      background:#fff;
    }
    tbody td.name-col{
      min-width:240px;
    }
    tbody td.reason-col{
      min-width:90px;
      max-width:110px;
      padding:10px 4px;
      text-align: center;
    }
    tbody td.reason-col input{
      width:18px;
      height:18px;
      margin:auto;
    }
    tbody tr:hover td{ background:#F9FAFB; }

    .estado{
      display:inline-flex;
      align-items:center;
      padding:3px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:900;
      border:1px solid rgba(0,0,0,.08);
      white-space:nowrap;
    }
    .estado.formacion{ background:rgba(57,169,0,.10); color:#14532D; border-color:rgba(20,83,45,.18); }
    .estado.condicionado{ background:rgba(245,158,11,.12); color:#7C2D12; border-color:rgba(124,45,18,.18); }

    input[type="checkbox"]{
      width:16px;
      height:16px;
      accent-color: var(--verde-sena);
    }

    /* Acordeón 4 */
    .sel-item{
      border:1px solid var(--gris-borde);
      border-radius:14px;
      padding:12px;
      margin-bottom:12px;
    }
    .sel-item:nth-child(15n+1){ background:#ffffff; }
    .sel-item:nth-child(15n+2){ background:#f8fafc; }
    .sel-item:nth-child(15n+3){ background:#f1f5f9; }
    .sel-item:nth-child(15n+4){ background:#e2e8f0; }
    .sel-item:nth-child(15n+5){ background:#cbd5f5; }
    .sel-item:nth-child(15n+6){ background:#cbd5df; }
    .sel-item:nth-child(15n+7){ background:#d8e2ec; }
    .sel-item:nth-child(15n+8){ background:#e5e7eb; }
    .sel-item:nth-child(15n+9){ background:#e3e8f0; }
    .sel-item:nth-child(15n+10){ background:#d1d5db; }
    .sel-item:nth-child(15n+11){ background:#cbd5dc; }
    .sel-item:nth-child(15n+12){ background:#c4c4c4; }
    .sel-item:nth-child(15n+13){ background:#e0e3ea; }
    .sel-item:nth-child(15n+14){ background:#f0f4fa; }
    .sel-item:nth-child(15n+15){ background:#dfe6ff; }
    .sel-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .sel-title{
      font-weight:900;
      font-size:14px;
    }
    .sel-meta{
      color:var(--texto-secundario);
      font-size:12px;
      margin-top:2px;
    }

    .motivo-box{
      border:1px solid var(--gris-borde);
      border-radius:14px;
      padding:12px;
      background:#F9FAFB;
      margin-top:10px;
    }
    .motivo-box h4{
      margin:0 0 8px 0;
      font-size:13px;
      font-weight:900;
    }
    .motivo-text{
      width:100%;
      min-height:110px;
      border:1px solid var(--gris-borde);
      border-radius:12px;
      padding:10px 12px;
      font-size:12.5px;
      color:#111827;
      line-height:1.35;
      background:#fff;
      resize:vertical;
      white-space:pre-wrap;
      outline:none;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--gris-borde);
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      background:#fff;
    }
    .chip button{
      border:none;
      background:transparent;
      cursor:pointer;
      font-weight:900;
      color:#6B7280;
      padding:0;
      line-height:1;
    }

    .divider{
      height:1px;
      background:var(--gris-borde);
      margin:12px 0;
    }

    /* =========================
       Overlay inicio (Instructor y Ambiente)
       ========================= */
    .hidden{ display:none !important; }

    #startOverlay{
      position:fixed;
      inset:0;
      background: linear-gradient(135deg, rgba(12,23,17,1) 0%, rgba(10,40,22,1) 45%, rgba(4,17,10,1) 100%);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      padding:18px;
      opacity:0;
      transition: opacity .25s ease;
    }
    #startOverlay.start-overlay--active{
      display:flex;
      opacity:1;
    }
    #startOverlay.start-overlay--closing{
      opacity:0;
    }
    #startCard{
      width:100%;
      max-width:660px;
    }
    #startCard.start-card{
      padding:32px;
      border-radius:26px;
      background:#ffffff;
      box-shadow:0 25px 60px rgba(0,0,0,.35);
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .start-card-header{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }
    .start-card-logo{
      width:60px;
      height:60px;
    }
    .start-card-header h2{
      margin:0;
      font-size:20px;
      letter-spacing:0.02em;
      color:#0f5f1d;
    }
    .start-card-sub{
      margin:0;
      font-size:13px;
      color:var(--texto-secundario);
    }
    .start-card-body{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .start-fields{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .start-card-body label{
      font-size:12px;
      font-weight:700;
      color:#5d6b7d;
    }
    .start-card-body input{
      border-radius:18px;
      border:1px solid rgba(15,23,42,.15);
      background:#fff;
      padding:15px 16px;
      font-size:15px;
      color:#0f172a;
      outline:none;
      box-shadow:0 12px 25px rgba(15,23,42,.07);
      transition:border .2s ease, box-shadow .2s ease;
    }
    .start-card-body .start-input{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .start-card-body input:focus{
      border-color:rgba(57,169,0,.7);
      box-shadow:0 0 0 3px rgba(57,169,0,.12);
    }
    @keyframes startCardIn{
      from{ opacity:0; transform:translateY(22px) scale(0.97); }
      to{ opacity:1; transform:translateY(0) scale(1); }
    }
    @keyframes startCardOut{
      from{ opacity:1; transform:translateY(0) scale(1); }
      to{ opacity:0; transform:translateY(12px) scale(0.96); }
    }
    .start-card-enter{
      animation: startCardIn .45s cubic-bezier(.17,.67,.4,1.01) both;
    }
    .start-card-exit{
      animation: startCardOut .3s ease both;
    }
    #startInstructorNombre{
      background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%27http://www.w3.org/2000/svg%27%20viewBox%3D%270%200%2024%2024%27%3E%3Cpath%20fill%3D%27%239ca3af%27%20d%3D%27M12%2012c2.7%200%205%202.3%205%205v2H7v-2c0-2.7%202.3-5%205-5zm0-2a3%203%200%201%200%200-6%203%203%200%200%200%200%206z%27/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position:16px center;
      background-size:20px;
      padding-left:48px;
    }
    #startAmbienteFormacion{
      background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%27http://www.w3.org/2000/svg%27%20viewBox%3D%270%200%2024%2024%27%3E%3Cpath%20fill%3D%27%239ca3af%27%20d%3D%27M4%203h16v18H4V3zm2%202v14h12V5H6zm3%203h2v3H9V8zm4%200h2v3h-2V8z%27/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position:16px center;
      background-size:20px;
      padding-left:48px;
    }
    .start-card-body input::placeholder{
      color:#9fa7b4;
    }
    #btnIniciar{
      width:100%;
      border-radius:16px;
      padding:14px 0;
      font-size:16px;
      text-transform:none;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    #btnIniciar::after{
      content:"→";
      font-size:18px;
    }
    .start-card-body .row{
      width:100%;
    }

    /* Columnas de motivos en tabla (más angostas) */
    thead th.th-motivo{
      min-width:95px !important;
      max-width:95px !important;
      text-align:center;
      white-space:normal;
      line-height:1.15;
    }

    tbody td.td-motivo{
      width:95px;
      text-align:center;
    }

    /* Colores por tipo de motivo (para diferenciar visualmente) */
    .motivo-box[data-reason="uniforme"],
    .motivo-box[data-reason="plagio"]{
      background: rgba(57,169,0,.10);
      border-color: rgba(20,83,45,.25);
    }
    .motivo-box[data-reason="tarde"]{
      background: rgba(249,190,0,.16);
      border-color: rgba(217,119,6,.28);
    }
    .motivo-box[data-reason="inasistencias"]{
      background: rgba(220,38,38,.08);
      border-color: rgba(185,28,28,.25);
    }
    .motivo-box[data-reason="noEvidencias"]{
      background: rgba(37,99,235,.08);
      border-color: rgba(29,78,216,.25);
    }
    .motivo-box[data-reason="actitudinal"]{
      background: rgba(124,58,237,.10);
      border-color: rgba(109,40,217,.25);
    }
    .motivo-box[data-reason="otro"]{
      background: rgba(234,88,12,.10);
      border-color: rgba(194,65,12,.25);
    }

  </style>
</head>

<body>

  <!-- INICIO: Datos iniciales (Instructor y Ambiente) -->
  <div id="startOverlay">
    <div id="startCard" class="card start-card">
      <div class="start-card-header">
        <img src="https://www.sena.edu.co/Style%20Library/alayout/images/logoSena.png" alt="Logo SENA" class="start-card-logo">
        <div>
          <h2>Llamados de Atención</h2>
          <p class="start-card-sub">Ingresa instructor y ambiente para comenzar el flujo.</p>
        </div>
      </div>
      <div class="start-card-body">
        <div class="start-fields">
          <div class="start-input">
            <label for="startInstructorNombre">Nombre del Instructor</label>
            <input type="text" id="startInstructorNombre" placeholder="Nombre del Instructor" autocomplete="off" />
          </div>
          <div class="start-input">
            <label for="startAmbienteFormacion">Número de Ambiente</label>
            <input type="text" id="startAmbienteFormacion" placeholder="Número de Ambiente" autocomplete="off" />
          </div>
        </div>
        <div class="row" style="margin-top:18px;">
          <button class="btn secondary" id="btnIniciar">Continuar</button>
        </div>
        <div class="alert" id="startAlert" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>
  <!-- FIN: Datos iniciales -->

  <header>
    <div class="header-content">
      <div class="header-left">
        <img src="https://www.sena.edu.co/Style%20Library/alayout/images/logoSena.png" alt="Logo SENA">
        <div class="header-left-text">Servicio Nacional de Aprendizaje - SENA Regional Tolima</div>
      </div>
      <div class="header-center">Llamados de Atención</div>
      <div class="header-right">Centro de Comercio y Servicios</div>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="card-header">
        <div>
          <h2>Generador de Llamados de Atención</h2>
          <div class="sub">Cargue el archivo, seleccione aprendices/motivos y genere un PDF con 1 página por aprendiz.</div>
        </div>
        <div class="pill" id="pillEstado">Sin archivo</div>
      </div>

      <div class="acordeon">

        <!-- 1. Archivo -->
        <div class="acordeon-item open" id="accFile">
          <button class="acordeon-header" type="button" data-acc="accFile">
            <span>1) Cargar archivo (Llamados de atención)</span>
            <span class="pill" id="pillArchivo">Pendiente</span>
          </button>
          <div class="acordeon-body">
            <div class="hero-section">
              <div class="hero-icon">
                <svg viewBox="0 0 24 24"><path d="M16 4H8c-1.1 0-2 .9-2 2v12a2 2 0 002 2h8a2 2 0 002-2V6c0-1.1-.9-2-2-2zm0 14H8V6h8v12zm-4-9 2 2h-2v3h-2V11H8l4-4z"/></svg>
              </div>
              <div class="hero-title">Cargar Reporte de Juicios</div>
              <div class="hero-sub">Sube el archivo Excel o CSV descargado de SofiaPlus con los juicios de evaluación. Rol (Gestion de Desarrollo Curricular o Instructor) › Ejecucion de la formacion › Reportes › Reportes de Juicio de Evaluacion. El sistema identificará automáticamente los aprendices en EN FORMACION o CONDICIONADO.</div>
            </div>
            <div class="drop-zone" id="dropZone">
              <input type="file" id="excelFile" accept=".xls,.xlsx,.csv" />
              <div class="drop-content">
                <div>Haz clic para subir o arrastra y suelta aquí</div>
                <small>XLSX, XLS, CSV (Máx. 10MB)</small>
              </div>
            </div>
            <div class="row" style="margin-top:10px;">
              <button class="btn" id="btnProcesar" disabled>Procesar archivo</button>
              <button class="btn ghost" id="btnLimpiar" disabled>Limpiar</button>
            </div>
            <div class="note" id="notaArchivo"></div>
            <div class="alert" id="alerta"></div>
          </div>
        </div>

        <!-- 2. Instructor + Ambiente -->
        <div class="acordeon-item" id="accInstructor" style="display:none;">
          <button class="acordeon-header" type="button" data-acc="accInstructor">
            <span>2) Datos del llamado</span>
            <span class="pill" id="pillDatos">Pendiente</span>
          </button>
          <div class="acordeon-body">
            <div class="grid">
              <div>
                <label for="instructorNombre">Nombre del instructor que hace el llamado de atención</label>
                <input type="text" id="instructorNombre" placeholder="Ej: Juan Pérez" autocomplete="off" />
              </div>
              <div>
                <label for="ambienteFormacion">Ambiente de formación</label>
                <input type="text" id="ambienteFormacion" placeholder="Ej: Aula 201" autocomplete="off" />
              </div>
            </div>
            <div class="row" style="margin-top:12px;">
              <button class="btn" id="btnGuardarDatos">Guardar y continuar</button>
            </div>
            <div class="note">Al guardar, este acordeón se ocultará y quedará habilitada la selección de aprendices.</div>
          </div>
        </div>

        <!-- 3. Selección -->
        <div class="acordeon-item" id="accSeleccion" style="display:none;">
          <button class="acordeon-header" type="button" data-acc="accSeleccion">
            <span>2) Selección de aprendices y motivos</span>
            <span class="pill" id="pillSeleccion">0 seleccionados</span>
          </button>
          <div class="acordeon-body">
          <div class="note" style="margin-bottom:10px;">
            <strong>Seleccione los aprendices a los cuales le realizará el llamado</strong>. Solo se listan estados <strong>EN FORMACIÓN</strong> y <strong>CONDICIONADO</strong>.
          </div>
          <div class="table-tools">
            <input type="text" id="tablaSearch" placeholder="Buscar por nombre, documento o estado" autocomplete="off" />
            <span class="table-tools__hint">Click en cada encabezado para ordenar A-Z / Z-A.</span>
          </div>
          <div id="tablaWrap"></div>
            <div class="row" style="margin-top:12px; justify-content:flex-end;">
              <button class="btn secondary" id="btnCargarDetalles" disabled>Cargar detalles</button>
            </div>
          </div>
        </div>

        <!-- 4. Detalle + PDF -->
        <div class="acordeon-item" id="accDetalle" style="display:none;">
          <button class="acordeon-header" type="button" data-acc="accDetalle">
            <span>3) Detalle del llamado y generación de PDF</span>
            <span class="pill" id="pillDetalle">Pendiente</span>
          </button>
          <div class="acordeon-body">
            <div class="note" style="margin-bottom:10px;">
              Aquí aparecerán los aprendices seleccionados. Por cada motivo marcado se mostrará un cuadro con el texto y campos adicionales.
            </div>

            <div id="seleccionadosWrap"></div>

            <div class="row" style="margin-top:14px; align-items:flex-start;">
              <div style="display:flex; flex-direction:column; gap:8px;">
                <label style="margin:0;">Modo de generación</label>
                <label class="row" style="margin:0; gap:8px;">
                  <input type="radio" name="genMode" id="genOne" value="one" checked>
                  <span>Generar 1 hoja X aprendiz (coloca todos los motivos en 1 sola hoja)</span>
                </label>
                <label class="row" style="margin:0; gap:8px;">
                  <input type="radio" name="genMode" id="genMany" value="many">
                  <span>Generar varias hojas por aprendiz (un llamado por motivo)</span>
                </label>
                <div class="note" id="notaGenMode"></div>
              </div>
            </div>

            <div class="row" style="margin-top:14px;">
              <button class="btn secondary" id="btnGenerar" disabled>Generar llamados de atención (PDF)</button>
              <button class="btn secondary" id="btnGenerarPorAprendiz" disabled>Generar llamados de atención por aprendiz (PDF)</button>
            </div>
            <div class="note">
              El primer botón abre un solo PDF con todos los aprendices (un llamado por hoja); el segundo genera un PDF por aprendiz con sus llamados y nombre sugerido en el título.
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // =========================
    // Estado
    // =========================
    const state = {
      groupName: "",
    fechaHoy: "",
    fechaHoyIso: "",
      aprendices: [], // {key, nombre, documento, estadoNorm, estadoRaw}
      instructor: "",
      ambiente: "",
      seleccion: {}, // {key: {uniforme:true, ...}}
      detalle: {}, // {key: {...}}
      genMode: "one", // one = 1 hoja por aprendiz (todos los motivos), multi = varias hojas por aprendiz (1 motivo por hoja)
      tableFilter: "",
      tableSort: { column: "nombre", dir: 1 }
    };

    const REASONS = [
      { key: "uniforme", label: "Mal porte del Uniforme" },
      { key: "tarde", label: "Llegadas tarde" },
      { key: "inasistencias", label: "Inasistencias" },
      { key: "noEvidencias", label: "No entrega de Evidencias" },
      { key: "plagio", label: "Plagio o Fraude" },
      { key: "actitudinal", label: "Actitudinal" },
      { key: "otro", label: "Otro" }
    ];

    const REASON_KEYS = new Set(REASONS.map(r => r.key));

    const NORMATIVOS = {
      uniforme:
`No cumplimiento del CAPÍTULO III. Artículo 8o. Deberes del aprendiz SENA
20. Portar el conjunto de prendas y elementos de trabajo y protección asociados al proceso formativo.`,
      plagio:
`No cumplimiento del CAPÍTULO III. Artículo 8 12. Respetar los derechos de autor y demás derechos de propiedad intelectual en los materiales, trabajos, proyectos y demás documentos entregados o generados en el proceso formativo.
Artículo 9o. Prohibiciones
4. Plagiar, materiales, trabajos y demás documentos generados en los grupos de trabajo o producto del trabajo en equipo institucional.`,
      tarde:
`No cumplimiento del CAPÍTULO III. Artículo 8o. Deberes del aprendiz SENA
5. Asistir con puntualidad a todas las actividades propias del proceso de formación.`,
      noEvidencias:
`No cumplimiento del CAPÍTULO III. Artículo 8o. Deberes del aprendiz SENA
6. Cumplir con todas las actividades de su proceso formativo, presentando las evidencias según la planeación pedagógica, guías de aprendizaje y cronograma, en los plazos o en la oportunidad que estas deban presentarse o reportarse, a través de los medios dispuestos para ello.`,
      inasistencias:
`No cumplimiento del CAPÍTULO III. Artículo 8o. Deberes del aprendiz SENA
7. Justificar debidamente las inasistencias o incumplimientos a las actividades de la formación, en los términos establecidos en el presente reglamento.`
    };

    const PLAN_BASE = {
      uniforme:
`Compromiso escrito de usar el uniforme completo en todas las sesiones formativas.
Seguimiento semanal por el instructor; incumplimiento escala a llamado de atención escrito.`,
      tarde:
`El aprendiz deberá firmar un compromiso donde se comprometa a asistir puntualmente a todas las actividades, presentar por escrito una justificación de su incumplimiento y una propuesta para mejorar su puntualidad.`,
      inasistencias:
`El aprendiz deberá firmar un compromiso donde se comprometa a asistir puntualmente a todas las actividades, presentar por escrito una justificación de su incumplimiento y una propuesta para mejorar su asistencia.
Durante la siguiente semana, se llevará un control de asistencia y puntualidad. En caso de reincidencia, se aplicarán medidas disciplinarias según el reglamento; de igual forma el aprendiz deberá ponerse al día con las temáticas abordadas mediante tutorías, trabajos complementarios o entrega de evidencias.`,
      noEvidencias: (fecha) =>
`Se establece una nueva fecha límite para la entrega de las evidencias pendientes el día ${fecha || "dd/mm/yyyy"}, con seguimiento por parte del instructor para garantizar el cumplimiento.`,
      plagio:
`Plan de mejoramiento académico (considerado falta grave o gravísima según magnitud).
Rehacer el trabajo/plagio desde cero, con citas correctas y originalidad.`
    };

    // =========================
    // Utilidades
    // =========================
    const $ = (id) => document.getElementById(id);

    function normalize(text){
      return (text ?? "")
        .toString()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .toUpperCase().trim().replace(/\s+/g," ");
    }

    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function nowDateTimeLocal(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const min = String(d.getMinutes()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
    }

    function todayDDMMYYYY(){
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    function formatLongDateFromIso(iso){
      if(!iso) return "";
      const [y,m,d] = iso.split("-");
      let date;
      if(y && m && d){
        date = new Date(Number(y), Number(m)-1, Number(d));
      }else{
        date = new Date(iso);
      }
      if(Number.isNaN(date.getTime())) return iso;
      return date.toLocaleDateString("es-CO", { weekday:"long", day:"2-digit", month:"long", year:"numeric" });
    }

    function toDDMMYYYY(iso){
      if(!iso) return "";
      const [y,m,d] = iso.split("-");
      if(!y||!m||!d) return iso;
      return `${d}/${m}/${y}`;
    }

    function escapeHtml(str){
      return (str ?? "").toString()
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function getAprMap(){
      return Object.fromEntries(state.aprendices.map(a => [a.key, a]));
    }

    function setPill(el, text, tone){
      const p = $(el);
      p.textContent = text;
      if(tone === "ok"){
        p.style.background = "rgba(57,169,0,.12)";
        p.style.color = "#14532D";
        p.style.borderColor = "rgba(20,83,45,.18)";
      }else if(tone === "warn"){
        p.style.background = "rgba(245,158,11,.14)";
        p.style.color = "#7C2D12";
        p.style.borderColor = "rgba(124,45,18,.18)";
      }else{
        p.style.background = "#EEF2FF";
        p.style.color = "#1E3A8A";
        p.style.borderColor = "rgba(30,58,138,.15)";
      }
    }

    function showAlert(msg){
      const a = $("alerta");
      a.textContent = msg;
      a.classList.add("show");
    }
    function hideAlert(){
      const a = $("alerta");
      a.textContent = "";
      a.classList.remove("show");
    }

    // =========================
    // Flujo de inicio (Instructor + Ambiente)
    // =========================
    function showStartAlert(msg){
      const a = $("startAlert");
      if(!a) return;
      a.textContent = msg;
      a.classList.add("show");
    }
    function hideStartAlert(){
      const a = $("startAlert");
      if(!a) return;
      a.textContent = "";
      a.classList.remove("show");
    }

    function showStartOverlay(){
      const overlay = $("startOverlay");
      if(!overlay) return;
      overlay.style.display = "flex";
      overlay.classList.remove("start-overlay--closing");
      overlay.classList.add("start-overlay--active");
      const card = $("startCard");
      if(card){
        card.classList.remove("start-card-exit");
        card.classList.add("start-card-enter");
      }
    }

    function hideStartOverlay(){
      const overlay = $("startOverlay");
      if(!overlay) return;
      const card = $("startCard");
      if(card){
        card.classList.remove("start-card-enter");
        card.classList.add("start-card-exit");
      }
      overlay.classList.remove("start-overlay--active");
      overlay.classList.add("start-overlay--closing");
      const cleanup = () => {
        overlay.style.display = "none";
        overlay.classList.remove("start-overlay--closing");
        overlay.removeEventListener("transitionend", cleanup);
      };
      overlay.addEventListener("transitionend", cleanup);
    }

    // Etapas UI:
    // - file: solo cargue de archivo
    // - loaded: archivo cargado, se muestra tabla
    // - detalle: se muestra sección de detalle/PDF
    function setStage(stage){
      const accFile = $("accFile");
      const accInstructor = $("accInstructor");
      const accSeleccion = $("accSeleccion");
      const accDetalle = $("accDetalle");

      if(accInstructor) accInstructor.style.display = "none"; // siempre oculto (se captura en inicio)

      if(stage === "file"){
        if(accSeleccion) accSeleccion.style.display = "none";
        if(accDetalle) accDetalle.style.display = "none";
        if(accFile) accFile.style.display = "";
        toggleAccordion("accFile", true);
      }else if(stage === "loaded"){
        if(accSeleccion) accSeleccion.style.display = "";
        if(accDetalle) accDetalle.style.display = "none";
        if(accFile) accFile.style.display = "";
      }else if(stage === "detalle"){
        if(accSeleccion) accSeleccion.style.display = "";
        if(accDetalle) accDetalle.style.display = "";
        if(accFile) accFile.style.display = "";
      }
    }

    function initProject(){
      setStage("file");

      // Siempre solicitar al inicio (por sesión)
      if($("startInstructorNombre")) $("startInstructorNombre").value = "";
      if($("startAmbienteFormacion")) $("startAmbienteFormacion").value = "";
      showStartOverlay();
      $("pillEstado").textContent = "Ingrese datos iniciales";
    }

    const btnIniciar = $("btnIniciar");
    if(btnIniciar){
      btnIniciar.addEventListener("click", () => {
        hideStartAlert();
        const instructor = ($("startInstructorNombre")?.value || "").trim();
        const ambiente = ($("startAmbienteFormacion")?.value || "").trim();

        if(!instructor || !ambiente){
          showStartAlert("Debe diligenciar: Instructor y Ambiente.");
          return;
        }

        const instructorUpper = instructor.toUpperCase();
        const ambienteUpper = ambiente.toUpperCase();
        state.instructor = instructorUpper;
        state.ambiente = ambienteUpper;
        $("startInstructorNombre").value = instructorUpper;
        $("startAmbienteFormacion").value = ambienteUpper;

                setPill("pillDatos","Completado","ok");
        $("pillEstado").textContent = "Listo para cargar archivo";

        hideStartOverlay();

        setStage("file");
      });
    }

    // =========================
    // Acordeón
    // =========================
    function toggleAccordion(id, open){
      const el = $(id);
      if(!el) return;
      const willOpen = (open !== undefined) ? open : !el.classList.contains("open");
      el.classList.toggle("open", willOpen);
    }

    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".acordeon-header");
      if(!btn) return;
      const id = btn.dataset.acc;
      if(!id) return;
      toggleAccordion(id);
    });

    // =========================
    // Archivo Excel
    // =========================
    $("excelFile").addEventListener("change", () => {
      hideAlert();
      $("btnProcesar").disabled = !$("excelFile").files?.length;
    });

    const dropZone = $("dropZone");
    if(dropZone){
      const setFileFromDrop = (files) => {
        if(!files || files.length === 0) return;
        const input = $("excelFile");
        if(!input) return;
        const dt = new DataTransfer();
        dt.items.add(files[0]);
        input.files = dt.files;
        input.dispatchEvent(new Event("change", { bubbles: true }));
      };
      const prevent = (e) => {
        e.preventDefault();
        e.stopPropagation();
      };
      ["dragenter","dragover"].forEach(evt => {
        dropZone.addEventListener(evt, (e) => {
          prevent(e);
          dropZone.classList.add("drop-zone--active");
        });
      });
      ["dragleave","dragend","drop"].forEach(evt => {
        dropZone.addEventListener(evt, (e) => {
          prevent(e);
          if(evt === "drop"){
            dropZone.classList.remove("drop-zone--active");
            setFileFromDrop(e.dataTransfer?.files);
          }else{
            dropZone.classList.remove("drop-zone--active");
          }
        });
      });
    }

    $("btnProcesar").addEventListener("click", async () => {
      hideAlert();
      const file = $("excelFile").files?.[0];
      if(!file){
        showAlert("Seleccione un archivo XLS/XLSX.");
        return;
      }

      try{
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, {type:"array"});
        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];

        state.groupName = (ws["C6"] && ws["C6"].v) ? ws["C6"].v.toString().trim() : "";
        state.fechaHoy = todayDDMMYYYY();
        state.fechaHoyIso = todayISO();

        const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
        state.aprendices = parseAprendicesFromRows(rows);

        if(state.aprendices.length === 0){
          showAlert("No se encontraron aprendices en estado FORMACION o CONDICIONADO. Revise el archivo.");
          setPill("pillArchivo","Sin registros","warn");
          return;
        }

        setPill("pillArchivo", `Cargado (${state.aprendices.length})`, "ok");
        $("pillEstado").textContent = "Archivo cargado";
        $("btnLimpiar").disabled = false;

        // Reiniciar selección/detalle por archivo
        state.seleccion = {};
        state.detalle = {};
        state.tableFilter = "";
        state.tableSort = { column: "nombre", dir: 1 };
        const tablaSearch = $("tablaSearch");
        if(tablaSearch) tablaSearch.value = "";
        setPill("pillSeleccion","0 seleccionados");
        setPill("pillDetalle","Pendiente");
        $("btnCargarDetalles").disabled = true;
        $("btnGenerar").disabled = true;

        // Validar que ya existan datos iniciales (capturados al inicio)
        if(!state.instructor || !state.ambiente){
          showStartOverlay();
          $("pillEstado").textContent = "Ingrese datos iniciales";
          showAlert("Antes de continuar, diligencie Instructor y Ambiente.");
          return;
        }
        setPill("pillDatos","Completado","ok");

        renderTabla();

        setStage("loaded");
        toggleAccordion("accFile", false);
        toggleAccordion("accSeleccion", true);
$("notaArchivo").textContent = state.groupName
          ? `Grupo detectado desde C6: ${state.groupName}`
          : "Grupo (C6): no detectado. Se imprimirá como N/A.";

      }catch(err){
        console.error(err);
        showAlert("No fue posible procesar el archivo. Verifique que sea un XLS/XLSX válido.");
        setPill("pillArchivo","Error","warn");
      }
    });

    $("btnLimpiar").addEventListener("click", () => {
      state.groupName = "";
      state.fechaHoy = "";
      state.fechaHoyIso = "";
      state.aprendices = [];
      state.seleccion = {};
      state.detalle = {};
      state.tableFilter = "";
      state.tableSort = { column: "nombre", dir: 1 };

      $("excelFile").value = "";
      if($("tablaSearch")) $("tablaSearch").value = "";

      $("tablaWrap").innerHTML = "";
      $("seleccionadosWrap").innerHTML = "";

      $("btnProcesar").disabled = true;
      $("btnLimpiar").disabled = true;
      $("btnGenerar").disabled = true;
      if($("btnGenerarPorAprendiz")) $("btnGenerarPorAprendiz").disabled = true;
      $("btnCargarDetalles").disabled = true;

      setPill("pillArchivo","Pendiente");
      setPill("pillDatos","Completado","ok");
      setPill("pillSeleccion","0 seleccionados");
      setPill("pillDetalle","Pendiente");

      $("pillEstado").textContent = "Sin archivo";
      $("notaArchivo").textContent = "";
      hideAlert();

      $("pillEstado").textContent = "Listo para cargar archivo";
      setStage("file");
      toggleAccordion("accFile", true);
    });

    function parseAprendicesFromRows(rows){
      const maxScan = Math.min(rows.length, 80);

      // En reportes como "Reporte de Juicios Evaluativos" existen dos columnas:
      // - "Tipo de Documento" (CC, TI, etc.)
      // - "Número de Documento" (identificador real)
      // Por eso seleccionamos la columna de documento por puntuación, evitando tomar "Tipo de Documento".

      const NOM_KEYS = ["NOMBRE","NOMBRES","APRENDIZ","NOMBRE APRENDIZ","NOMBRES Y APELLIDOS","NOMBRE COMPLETO"];
      const APE_KEYS = ["APELLIDO","APELLIDOS"];
      const EST_KEYS = ["ESTADO","ESTADO APRENDIZ","CONDICION","ESTADO DE APRENDIZ","ESTADO DE MATRICULA","SITUACION"];

      function hasAny(cellNorm, keys){
        return keys.some(k => cellNorm === k || cellNorm.includes(k));
      }

      function findBestColumn(header, scorer){
        let bestIdx = -1;
        let bestScore = 0;
        for(let i=0; i<header.length; i++){
          const h = header[i];
          const s = scorer(h);
          if(s > bestScore){
            bestScore = s;
            bestIdx = i;
          }
        }
        return bestIdx;
      }

      function scoreDocNo(h){
        if(!h) return 0;
        let s = 0;

        // Altamente específicos
        if(h === "NUMERO DE DOCUMENTO") s += 120;
        if(h.includes("NUMERO DE DOCUMENTO")) s += 110;
        if(h.includes("NUMERO DOCUMENTO")) s += 105;
        if(h.includes("NRO") && h.includes("DOCUMENTO")) s += 95;
        if(h.includes("NUM DOC")) s += 90;
        if(h.includes("DOCUMENTO") && h.includes("APRENDIZ")) s += 85;
        if(h.includes("IDENTIFICACION")) s += 80;

        // Genéricos (bajo)
        if(h === "DOCUMENTO") s += 40;
        if(h.includes("DOCUMENTO")) s += 10;

        // Penalizar "Tipo de Documento"
        if(h.includes("TIPO") && h.includes("DOCUMENTO")) s -= 200;

        return s;
      }

      function cleanDoc(v){
        if(v === null || v === undefined) return "";
        if(typeof v === "number" && isFinite(v)){
          return String(Math.trunc(v));
        }
        let s = v.toString().trim();
        s = s.replace(/\.0+$/,"");          // 12345.0 -> 12345
        const digits = s.replace(/\D/g,""); // quita separadores / espacios
        if(digits.length >= 6) return digits;
        return s;
      }

      // 1) Detectar fila de encabezados
      let headerRow = -1;
      let bestScore = 0;

      for(let r=0; r<maxScan; r++){
        const row = rows[r] || [];
        let score = 0;

        for(const cell of row){
          const n = normalize(cell);
          if(!n) continue;

          // Documento (número) -> buscamos NUMERO+DOCUMENTO, evitando TIPO+DOCUMENTO
          if(n.includes("NUMERO") && n.includes("DOCUMENTO") && !n.includes("TIPO")) score += 2;

          if(hasAny(n, NOM_KEYS)) score++;
          if(hasAny(n, EST_KEYS)) score++;
        }

        if(score > bestScore){
          bestScore = score;
          headerRow = r;
        }
      }

      if(headerRow < 0 || bestScore < 2) return [];

      const header = (rows[headerRow] || []).map(c => normalize(c));

      const colDocNo = findBestColumn(header, scoreDocNo);
      const colNom = header.findIndex(h => hasAny(h, NOM_KEYS));
      const colApe = header.findIndex(h => hasAny(h, APE_KEYS));
      const colEst = header.findIndex(h => hasAny(h, EST_KEYS));

      if(colNom < 0 || colEst < 0) return [];

      // 2) Leer filas y consolidar (sin duplicados por Número de Documento)
      const prio = (est) => (est === "CONDICIONADO" ? 2 : 1);
      const byKey = new Map();

      for(let r=headerRow+1; r<rows.length; r++){
        const row = rows[r] || [];

        const rawEstado = (row[colEst] ?? "").toString().trim();
        if(!rawEstado) continue;

        const estNorm = normalize(rawEstado);

        // Solo EN FORMACION o CONDICIONADO
        const isFormacion = estNorm.includes("EN FORMACION") || estNorm === "FORMACION" || estNorm.includes("FORMACION");
        const isCond = estNorm.includes("CONDICIONADO") || estNorm.includes("CONDICIONADO(A)") || estNorm === "CONDICIONADO" || estNorm.includes("CONDICION");
        if(!isFormacion && !isCond) continue;

        const doc = (colDocNo >= 0 ? cleanDoc(row[colDocNo]) : "");
        const nom = (row[colNom] ?? "").toString().trim();
        const ape = (colApe >= 0 ? (row[colApe] ?? "").toString().trim() : "");

        const nombre = (ape ? `${nom} ${ape}` : nom).replace(/\s+/g," ").trim();
        if(!nombre) continue;

        const key = doc ? `D:${doc}` : `N:${normalize(nombre)}`;
        if(!key || key === "N:") continue;

        const cand = {
          key,
          nombre,
          documento: doc || "",
          estadoNorm: isCond ? "CONDICIONADO" : "EN FORMACION",
          estadoRaw: rawEstado
        };

        if(!byKey.has(key)){
          byKey.set(key, cand);
        }else{
          const cur = byKey.get(key);
          if(prio(cand.estadoNorm) > prio(cur.estadoNorm)){
            byKey.set(key, cand);
          }else if(prio(cand.estadoNorm) === prio(cur.estadoNorm)){
            if((cand.nombre || "").length > (cur.nombre || "").length){
              byKey.set(key, cand);
            }
          }
        }
      }

      const out = Array.from(byKey.values());
      out.sort((a,b) => a.nombre.localeCompare(b.nombre, "es", {sensitivity:"base"}));
      return out;
    }

    // =========================
    // Paso 2
    // =========================
    $("btnGuardarDatos").addEventListener("click", () => {
      hideAlert();
      const instructor = $("instructorNombre").value.trim();
      const ambiente = $("ambienteFormacion").value.trim();

      if(!instructor || !ambiente){
        showAlert("Debe diligenciar: nombre del instructor y ambiente de formación.");
        return;
      }

      state.instructor = instructor;
      state.ambiente = ambiente;

      setPill("pillDatos","Completado","ok");

      $("accInstructor").style.display = "none";
      toggleAccordion("accSeleccion", true);

      $("pillEstado").textContent = "Listo para seleccionar";
    });

    // =========================
    // Modo de generación (1 hoja vs varias)
    // =========================
    document.addEventListener("change", (e) => {
      const t = e.target;
      if(t && t.name === "genMode"){
        state.genMode = t.value === "many" ? "many" : "one";
        updateGenModeAvailability();
      }
    });

    // =========================
    // Selección (tabla)
    // =========================
    function ensureDetalle(apKey){
      if(state.detalle[apKey]) return;
      state.detalle[apKey] = {
      lateDt: nowDateTimeLocal(),
        lateEntries: [],
        evidencias: "",
        noEntregaFecha: "",
        inasistencias: [],
        inasDefaultDate: todayISO(),
        observaciones: "", // solo para PDF (se deja en blanco en UI)
        motivoOverride: {}, // {reasonKey: string}
        motivoEdited: {}, // {reasonKey: true}
        custom: {
          actitudinal: { motivo: "", plan: "" },
          otro: { motivo: "", plan: "" }
        },
        planOverride: {
          uniforme: PLAN_BASE.uniforme,
          tarde: PLAN_BASE.tarde,
          inasistencias: PLAN_BASE.inasistencias,
          plagio: PLAN_BASE.plagio,
          noEvidencias: PLAN_BASE.noEvidencias("")
        }
      };
    }

    function updateSeleccionCounters(){
      const selKeys = Object.keys(state.seleccion);
      const n = selKeys.length;
      setPill("pillSeleccion", `${n} seleccionados`, n>0 ? "ok" : undefined);
      setPill("pillDetalle", n>0 ? `Listo (${n})` : "Pendiente", n>0 ? "ok" : "warn");
      const btnReady = (n > 0 && state.instructor && state.ambiente);
      $("btnGenerar").disabled = !btnReady;
      if($("btnGenerarPorAprendiz")){
        const multiAprEnabled = n > 1 && state.instructor && state.ambiente;
        $("btnGenerarPorAprendiz").disabled = !multiAprEnabled;
      }
      const btnDetalles = $("btnCargarDetalles");
      if(btnDetalles){
        btnDetalles.disabled = (n === 0);
      }

      updateGenModeAvailability();
    }

    function countReasonsFor(apKey){
      return Object.entries(state.seleccion[apKey] || {}).filter(([_,v]) => v).length;
    }

    function updateGenModeAvailability(){
      const selKeys = Object.keys(state.seleccion);
      const genMany = $("genMany");
      const genOne = $("genOne");
      const nota = $("notaGenMode");
      if(!genMany || !genOne || !nota) return;

      if(selKeys.length === 0){
        genMany.disabled = true;
        genOne.checked = true;
        state.genMode = "one";
        nota.textContent = "";
        return;
      }

      const someHaveMoreThanOne = selKeys.some(k => countReasonsFor(k) > 1);
      genMany.disabled = !someHaveMoreThanOne;

      if(genMany.disabled){
        if(genMany.checked){
          genOne.checked = true;
          state.genMode = "one";
        }
        nota.textContent = "La opción de varias hojas solo está disponible cuando al menos un aprendiz tiene 2 o más motivos.";
      }else{
        nota.textContent = "";
      }
    }

    function renderTabla(){
      const wrap = $("tablaWrap");
      if(!wrap) return;

      const totalColumns = 4 + REASONS.length;
      const displayAprendices = getFilteredSortedAprendices();

      const createHeaderCell = (key, label, extraClass) => {
        const classes = [];
        if(extraClass) classes.push(extraClass);
        classes.push("sortable");
        if(REASON_KEYS.has(key) && !classes.includes("reason-col")){
          classes.push("reason-col");
        }
        const indicator = (state.tableSort.column === key)
          ? (state.tableSort.dir === 1 ? " ▲" : " ▼")
          : "";
        return `<th class="${classes.join(" ")}" data-sort-key="${key}"><span>${escapeHtml(label)}</span><span class="sort-indicator">${indicator}</span></th>`;
      };

      const headerCells = [
        createHeaderCell("n", "N"),
        createHeaderCell("nombre", "Nombre", "name-col"),
        createHeaderCell("documento", "Documento"),
        createHeaderCell("estado", "Estado")
      ];
      const reasonHeader = REASONS.map(r => createHeaderCell(r.key, r.label, "reason-col")).join("");

      const bodyRows = displayAprendices.length
        ? displayAprendices.map((a, idx) => {
            const estClass = a.estadoNorm === "CONDICIONADO" ? "condicionado" : "formacion";
            return `
              <tr>
                <td>${idx+1}</td>
                <td class="name-col"><strong>${escapeHtml(a.nombre)}</strong></td>
                <td>${escapeHtml(a.documento || "")}</td>
                <td><span class="estado ${estClass}">${escapeHtml(a.estadoNorm)}</span></td>
                ${REASONS.map(r => {
                  const checked = !!(state.seleccion[a.key]?.[r.key]);
                  return `<td class="reason-col">
                    <input type="checkbox" data-ap="${escapeHtml(a.key)}" data-reason="${escapeHtml(r.key)}" ${checked ? "checked" : ""}>
                  </td>`;
                }).join("")}
              </tr>
            `;
          }).join("")
        : `<tr><td colspan="${totalColumns}" style="text-align:center;">No hay aprendices que coincidan con la búsqueda.</td></tr>`;

      wrap.innerHTML = `
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                ${headerCells.join("")}
                ${reasonHeader}
              </tr>
            </thead>
            <tbody>${bodyRows}</tbody>
          </table>
        </div>
      `;

      wrap.querySelectorAll("th.sortable").forEach(th => {
        th.addEventListener("click", () => {
          const key = th.dataset.sortKey;
          if(!key) return;
          if(state.tableSort.column === key){
            state.tableSort.dir = state.tableSort.dir === 1 ? -1 : 1;
          }else{
            state.tableSort.column = key;
            state.tableSort.dir = 1;
          }
          renderTabla();
        });
      });

      wrap.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener("change", (e) => {
          const ap = e.target.dataset.ap;
          const reason = e.target.dataset.reason;
          if(!ap || !reason) return;

          if(!state.seleccion[ap]) state.seleccion[ap] = {};
          state.seleccion[ap][reason] = e.target.checked;

          if(!Object.values(state.seleccion[ap]).some(v => v)){
            delete state.seleccion[ap];
            delete state.detalle[ap];
          }else{
            ensureDetalle(ap);
          }

          updateSeleccionCounters();
          renderSeleccionados();
        });
      });

      updateSeleccionCounters();
      renderSeleccionados();
    }

    function getFilteredSortedAprendices(){
      const filter = (state.tableFilter || "").toLowerCase().trim();
      let list = state.aprendices.slice();
      if(filter){
        list = list.filter(a => {
          const hay = `${a.nombre} ${a.documento} ${a.estadoNorm}`.toLowerCase();
          return hay.includes(filter);
        });
      }
      const sortKey = state.tableSort.column;
      const dir = state.tableSort.dir || 1;
      if(sortKey){
        list.sort((a,b) => {
          if(REASON_KEYS.has(sortKey)){
            const valA = state.seleccion[a.key]?.[sortKey] ? 1 : 0;
            const valB = state.seleccion[b.key]?.[sortKey] ? 1 : 0;
            return (valA - valB) * dir;
          }
          const valA = getSortStringValue(a, sortKey);
          const valB = getSortStringValue(b, sortKey);
          return valA.localeCompare(valB, "es", {sensitivity:"base"}) * dir;
        });
      }
      return list;
    }

    function getSortStringValue(aprendiz, column){
      if(column === "documento") return aprendiz.documento || "";
      if(column === "estado") return aprendiz.estadoNorm || "";
      return aprendiz.nombre || "";
    }

    const tablaSearchInput = $("tablaSearch");
    if(tablaSearchInput){
      tablaSearchInput.addEventListener("input", (e) => {
        state.tableFilter = e.target.value;
        renderTabla();
      });
    }

    // =========================
    // Acordeón 4 (detalle)
    // =========================
    function renderSeleccionados(){
      const wrap = $("seleccionadosWrap");
      const selKeys = Object.keys(state.seleccion);

      if(selKeys.length === 0){
        wrap.innerHTML = `<div class="note">Aún no hay aprendices seleccionados.</div>`;
        toggleAccordion("accDetalle", false);
        setStage("loaded");
        return;
      }

      const mapApr = Object.fromEntries(state.aprendices.map(a => [a.key, a]));
      const htmlItems = selKeys.map((k) => {
        const a = mapApr[k];
        if(!a) return "";

        ensureDetalle(k);
        const reasonsChecked = Object.entries(state.seleccion[k]).filter(([_,v]) => v).map(([rk]) => rk);

        return `
          <div class="sel-item">
            <div class="sel-head">
              <div>
                <div class="sel-title">${escapeHtml(a.nombre)}</div>
                <div class="sel-meta">Documento: ${escapeHtml(a.documento || "N/A")} · Estado: ${escapeHtml(a.estadoNorm)}</div>
              </div>
              <button class="btn ghost" type="button" data-clear="${escapeHtml(k)}">Quitar selección</button>
            </div>

            ${reasonsChecked.map(rk => renderMotivoBox(k, rk)).join("")}

            <div class="divider"></div>
          </div>
        `;
      }).join("");

      wrap.innerHTML = htmlItems;

      // Quitar selección
      wrap.querySelectorAll("button[data-clear]").forEach(btn => {
        btn.addEventListener("click", () => {
          const k = btn.dataset.clear;
          delete state.seleccion[k];
          delete state.detalle[k];
          renderTabla();
        });
      });

      bindDetalleInputs(wrap);
    }

    function renderMotivoBox(apKey, reasonKey){
      const label = (REASONS.find(r => r.key === reasonKey)?.label) || reasonKey;

      let motivoText = "";
      let extrasHTML = "";
      let planKey = null; // para planOverride
      let planDefault = "";
      let isCustomPlan = false;

      if(reasonKey === "uniforme"){
        motivoText = NORMATIVOS.uniforme;
        planKey = "uniforme";
        planDefault = PLAN_BASE.uniforme;

      }else if(reasonKey === "plagio"){
        motivoText = NORMATIVOS.plagio;
        planKey = "plagio";
        planDefault = PLAN_BASE.plagio;

      }else if(reasonKey === "tarde"){
        motivoText = NORMATIVOS.tarde;
        extrasHTML = `
          <div style="margin-top:10px;">
            <label>Día y hora que llegó tarde a formación</label>
            <div class="row" style="gap:10px; flex-wrap:wrap;">
              <input type="datetime-local" data-late="${escapeHtml(apKey)}" value="${nowDateTimeLocal()}">
              <button class="btn ghost" type="button" data-add-late="${escapeHtml(apKey)}">Agregar otro día</button>
            </div>
            <div class="chips" data-late-chips="${escapeHtml(apKey)}"></div>
          </div>
        `;
        planKey = "tarde";
        planDefault = PLAN_BASE.tarde;

      }else if(reasonKey === "noEvidencias"){
        motivoText = NORMATIVOS.noEvidencias;
        extrasHTML = `
          <div style="margin-top:10px;" class="grid">
            <div>
              <label>Nombre evidencias (puede usar comas)</label>
              <input type="text" data-evid="${escapeHtml(apKey)}" placeholder="Ej: Evidencia 1, Evidencia 2">
            </div>
            <div>
              <label>Nueva fecha límite de entrega</label>
              <input type="date" data-noe-fecha="${escapeHtml(apKey)}" value="${todayISO()}">
            </div>
          </div>
        `;
        planKey = "noEvidencias";
        planDefault = PLAN_BASE.noEvidencias("dd/mm/yyyy");

      }else if(reasonKey === "inasistencias"){
        motivoText = NORMATIVOS.inasistencias;
        extrasHTML = `
          <div style="margin-top:10px;">
            <label>Días de inasistencia</label>
            <div class="row">
              <input type="date" data-inas-date="${escapeHtml(apKey)}" value="${todayISO()}" style="max-width:220px;">
              <button class="btn ghost" type="button" data-add-inas="${escapeHtml(apKey)}">Agregar día</button>
            </div>
            <div class="chips" data-inas-chips="${escapeHtml(apKey)}"></div>
          </div>
        `;
        planKey = "inasistencias";
        planDefault = PLAN_BASE.inasistencias;

      }else if(reasonKey === "actitudinal"){
        isCustomPlan = true;
        extrasHTML = `
          <div style="margin-top:10px;">
            <label>Motivo (Actitudinal)</label>
            <textarea data-custom-motivo="${escapeHtml(apKey)}" data-custom-type="actitudinal" placeholder="Describa el motivo actitudinal."></textarea>
          </div>
          <div style="margin-top:10px;">
            <label>Plan de Mejoramiento (Actitudinal)</label>
            <textarea data-custom-plan="${escapeHtml(apKey)}" data-custom-type="actitudinal" placeholder="Describa el plan de mejoramiento."></textarea>
          </div>
        `;

      }else if(reasonKey === "otro"){
        isCustomPlan = true;
        extrasHTML = `
          <div style="margin-top:10px;">
            <label>Motivo (Otro)</label>
            <textarea data-custom-motivo="${escapeHtml(apKey)}" data-custom-type="otro" placeholder="Describa el motivo."></textarea>
          </div>
          <div style="margin-top:10px;">
            <label>Plan de Mejoramiento (Otro)</label>
            <textarea data-custom-plan="${escapeHtml(apKey)}" data-custom-type="otro" placeholder="Describa el plan de mejoramiento."></textarea>
          </div>
        `;
      }

      const planHTML = isCustomPlan
        ? ""  // en custom ya viene el textarea dentro de extrasHTML
        : `<textarea data-plan="${escapeHtml(apKey)}" data-plan-key="${escapeHtml(planKey)}"></textarea>`;

      return `
        <div class="motivo-box" data-reason="${escapeHtml(reasonKey)}">
          <h4>${escapeHtml(label)}</h4>
          ${motivoText ? `<textarea class="motivo-text" data-motivo="${escapeHtml(apKey)}" data-motivo-key="${escapeHtml(reasonKey)}"></textarea>` : ""}
          ${extrasHTML}
          ${planHTML ? `
            <div style="margin-top:10px;">
              <label>Plan de Mejoramiento</label>
              ${planHTML}
            </div>
          ` : ""}
        </div>
      `;
    }

    function bindDetalleInputs(container){
      // Motivo editable (override)
      container.querySelectorAll('textarea[data-motivo]').forEach(tx => {
        const ap = tx.dataset.motivo;
        const rk = tx.dataset.motivoKey;
        if(!ap || !rk) return;
        ensureDetalle(ap);
        if(state.detalle[ap].motivoOverride[rk] === undefined){
          state.detalle[ap].motivoOverride[rk] = defaultMotivoBody(ap, rk);
        }
        tx.value = state.detalle[ap].motivoOverride[rk] || "";
        tx.addEventListener("input", () => {
          ensureDetalle(ap);
          state.detalle[ap].motivoOverride[rk] = tx.value;
          state.detalle[ap].motivoEdited[rk] = true;
        });
      });

      // Planes override
      container.querySelectorAll("textarea[data-plan]").forEach(tx => {
        const ap = tx.dataset.plan;
        const pk = tx.dataset.planKey;
        ensureDetalle(ap);
        tx.value = state.detalle[ap].planOverride[pk] || "";
        tx.addEventListener("input", () => {
          ensureDetalle(ap);
          state.detalle[ap].planOverride[pk] = tx.value;
        });
      });

      // Llegadas tarde
      container.querySelectorAll('input[data-late]').forEach(inp => {
        const ap = inp.dataset.late;
        ensureDetalle(ap);
        inp.value = state.detalle[ap].lateDt || "";
        inp.addEventListener("change", () => {
          ensureDetalle(ap);
          state.detalle[ap].lateDt = inp.value;

          // Si el motivo no fue editado manualmente, se actualiza con la fecha/hora
          if(!state.detalle[ap].motivoEdited?.tarde){
            state.detalle[ap].motivoOverride.tarde = defaultMotivoBody(ap, "tarde");
            const mt = container.querySelector(`textarea[data-motivo="${CSS.escape(ap)}"][data-motivo-key="tarde"]`);
            if(mt) mt.value = state.detalle[ap].motivoOverride.tarde;
          }
        });
        renderLateChips(container, ap);
      });

      container.querySelectorAll('button[data-add-late]').forEach(btn => {
        btn.addEventListener("click", () => {
          const ap = btn.dataset.addLate;
          const input = container.querySelector(`input[data-late="${CSS.escape(ap)}"]`);
          if(!ap || !input || !input.value) return;
          ensureDetalle(ap);
          const iso = input.value;
          if(!state.detalle[ap].lateEntries.includes(iso)){
            state.detalle[ap].lateEntries.push(iso);
            state.detalle[ap].lateEntries.sort();
          }
          renderLateChips(container, ap);
          if(!state.detalle[ap].motivoEdited?.tarde){
            state.detalle[ap].motivoOverride.tarde = defaultMotivoBody(ap, "tarde");
            const mt = container.querySelector(`textarea[data-motivo="${CSS.escape(ap)}"][data-motivo-key="tarde"]`);
            if(mt) mt.value = state.detalle[ap].motivoOverride.tarde;
          }
        });
      });

      container.querySelectorAll('button[data-del-late]').forEach(btn => {
        btn.addEventListener("click", () => {
          const ap = btn.dataset.delLate;
          const iso = btn.dataset.delDate;
          if(!ap || !iso) return;
          ensureDetalle(ap);
          state.detalle[ap].lateEntries = (state.detalle[ap].lateEntries || []).filter(d => d !== iso);
          renderLateChips(container, ap);
          if(!state.detalle[ap].motivoEdited?.tarde){
            state.detalle[ap].motivoOverride.tarde = defaultMotivoBody(ap, "tarde");
            const mt = container.querySelector(`textarea[data-motivo="${CSS.escape(ap)}"][data-motivo-key="tarde"]`);
            if(mt) mt.value = state.detalle[ap].motivoOverride.tarde;
          }
        });
      });

      // No evidencias - nombre
      container.querySelectorAll('input[data-evid]').forEach(inp => {
        const ap = inp.dataset.evid;
        ensureDetalle(ap);
        inp.value = state.detalle[ap].evidencias || "";
        inp.addEventListener("input", () => {
          ensureDetalle(ap);
          state.detalle[ap].evidencias = inp.value;

          if(!state.detalle[ap].motivoEdited?.noEvidencias){
            state.detalle[ap].motivoOverride.noEvidencias = defaultMotivoBody(ap, "noEvidencias");
            const mt = container.querySelector(`textarea[data-motivo="${CSS.escape(ap)}"][data-motivo-key="noEvidencias"]`);
            if(mt) mt.value = state.detalle[ap].motivoOverride.noEvidencias;
          }
        });
      });

      // No evidencias - fecha
      container.querySelectorAll('input[data-noe-fecha]').forEach(inp => {
        const ap = inp.dataset.noeFecha; // data-noe-fecha => noeFecha
        ensureDetalle(ap);
        inp.value = state.detalle[ap].noEntregaFecha || todayISO();
        inp.addEventListener("change", () => {
          ensureDetalle(ap);
          state.detalle[ap].noEntregaFecha = inp.value;

          const autoPlan = PLAN_BASE.noEvidencias(toDDMMYYYY(inp.value));
          const current = state.detalle[ap].planOverride.noEvidencias || "";
          // Si el usuario no modificó el plan, lo actualizamos con la fecha
          if(!current || current.includes("dd/mm/yyyy")){
            state.detalle[ap].planOverride.noEvidencias = autoPlan;
          }
          const tx = container.querySelector(`textarea[data-plan="${CSS.escape(ap)}"][data-plan-key="noEvidencias"]`);
          if(tx) tx.value = state.detalle[ap].planOverride.noEvidencias;
        });
      });

      // Inasistencias chips
      container.querySelectorAll('button[data-add-inas]').forEach(btn => {
        btn.addEventListener("click", () => {
          const ap = btn.dataset.addInas;
          ensureDetalle(ap);
          const dateInput = container.querySelector(`input[data-inas-date="${CSS.escape(ap)}"]`);
          if(!dateInput || !dateInput.value) return;
          const iso = dateInput.value;
          if(!state.detalle[ap].inasistencias.includes(iso)){
            state.detalle[ap].inasistencias.push(iso);
            state.detalle[ap].inasistencias.sort();
          }
          state.detalle[ap].inasDefaultDate = iso;
          renderInasChips(container, ap);

          if(!state.detalle[ap].motivoEdited?.inasistencias){
            state.detalle[ap].motivoOverride.inasistencias = defaultMotivoBody(ap, "inasistencias");
            const mt = container.querySelector(`textarea[data-motivo="${CSS.escape(ap)}"][data-motivo-key="inasistencias"]`);
            if(mt) mt.value = state.detalle[ap].motivoOverride.inasistencias;
          }
        });
      });

      container.querySelectorAll('input[data-inas-date]').forEach(inp => {
        const ap = inp.dataset.inasDate; // data-inas-date => inasDate
        ensureDetalle(ap);
        inp.value = state.detalle[ap].inasDefaultDate || todayISO();
        renderInasChips(container, ap);
      });

      // Custom motivos/planes
      container.querySelectorAll('textarea[data-custom-motivo]').forEach(tx => {
        const ap = tx.dataset.customMotivo; // data-custom-motivo => customMotivo
        const type = tx.dataset.customType;
        ensureDetalle(ap);
        tx.value = state.detalle[ap].custom[type].motivo || "";
        tx.addEventListener("input", () => {
          ensureDetalle(ap);
          state.detalle[ap].custom[type].motivo = tx.value;
        });
      });

      container.querySelectorAll('textarea[data-custom-plan]').forEach(tx => {
        const ap = tx.dataset.customPlan; // data-custom-plan => customPlan
        const type = tx.dataset.customType;
        ensureDetalle(ap);
        tx.value = state.detalle[ap].custom[type].plan || "";
        tx.addEventListener("input", () => {
          ensureDetalle(ap);
          state.detalle[ap].custom[type].plan = tx.value;
        });
      });
    }

    function renderInasChips(container, ap){
      const chipWrap = container.querySelector(`div[data-inas-chips="${CSS.escape(ap)}"]`);
      if(!chipWrap) return;
      ensureDetalle(ap);

      const dates = state.detalle[ap].inasistencias || [];
      chipWrap.innerHTML = dates.length ? dates.map(iso => {
        const ddmmy = toDDMMYYYY(iso);
        return `<span class="chip">${escapeHtml(ddmmy)} <button type="button" data-del-inas="${escapeHtml(ap)}" data-del-date="${escapeHtml(iso)}">×</button></span>`;
      }).join("") : `<div class="note">No hay días agregados.</div>`;

      chipWrap.querySelectorAll("button[data-del-inas]").forEach(btn => {
        btn.addEventListener("click", () => {
          const apKey = btn.dataset.delInas;
          const iso = btn.dataset.delDate;
          ensureDetalle(apKey);
          state.detalle[apKey].inasistencias = (state.detalle[apKey].inasistencias || []).filter(d => d !== iso);
          renderInasChips(container, apKey);

          if(!state.detalle[apKey].motivoEdited?.inasistencias){
            state.detalle[apKey].motivoOverride.inasistencias = defaultMotivoBody(apKey, "inasistencias");
            const mt = container.querySelector(`textarea[data-motivo="${CSS.escape(apKey)}"][data-motivo-key="inasistencias"]`);
            if(mt) mt.value = state.detalle[apKey].motivoOverride.inasistencias;
          }
        });
      });
    }

    function renderLateChips(container, ap){
      const chipWrap = container.querySelector(`div[data-late-chips="${CSS.escape(ap)}"]`);
      if(!chipWrap) return;
      ensureDetalle(ap);
      const entries = state.detalle[ap].lateEntries || [];
      chipWrap.innerHTML = entries.length ? entries.map(iso => {
        const dt = formatDateTimeLocal(iso);
        return `<span class="chip">${escapeHtml(dt)} <button type="button" data-del-late="${escapeHtml(ap)}" data-del-date="${escapeHtml(iso)}">×</button></span>`;
      }).join("") : `<div class="note">No hay días agregados.</div>`;

      chipWrap.querySelectorAll("button[data-del-late]").forEach(btn => {
        btn.addEventListener("click", () => {
          const apKey = btn.dataset.delLate;
          const iso = btn.dataset.delDate;
          ensureDetalle(apKey);
          state.detalle[apKey].lateEntries = (state.detalle[apKey].lateEntries || []).filter(d => d !== iso);
          renderLateChips(container, apKey);

          if(!state.detalle[apKey].motivoEdited?.tarde){
            state.detalle[apKey].motivoOverride.tarde = defaultMotivoBody(apKey, "tarde");
            const mt = container.querySelector(`textarea[data-motivo="${CSS.escape(apKey)}"][data-motivo-key="tarde"]`);
            if(mt) mt.value = state.detalle[apKey].motivoOverride.tarde;
          }
        });
      });
    }

    // =========================
    // Generación PDF (impresión)
    // =========================
    $("btnCargarDetalles").addEventListener("click", () => {
      hideAlert();
      const selKeys = Object.keys(state.seleccion);
      if(selKeys.length === 0){
        showAlert("Seleccione al menos un aprendiz antes de cargar los detalles.");
        return;
      }
      renderSeleccionados();
      setStage("detalle");
      toggleAccordion("accDetalle", true);
      toggleAccordion("accSeleccion", false);
    });

    $("btnGenerar").addEventListener("click", () => {
      hideAlert();

      if(!state.instructor || !state.ambiente){
        showAlert("Faltan los datos iniciales (Instructor y Ambiente). Recargue la página o diligéncielos nuevamente.");
        return;
      }
      const selKeys = Object.keys(state.seleccion);
      if(selKeys.length === 0){
        showAlert("No hay aprendices seleccionados.");
        return;
      }

      const mapApr = getAprMap();
      const pages = selKeys.map(k => buildPagesForApr(k, mapApr)).join("");

      const htmlPrint = `<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Llamados de Atención</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>${getPrintCss()}</style>
</head>
<body>
  ${pages}
  <script>
    window.addEventListener("load", () => setTimeout(() => window.print(), 600));
  <\/script>
</body>
</html>`;

      const w = window.open("", "_blank");
      if(!w){
        showAlert("El navegador bloqueó la ventana emergente. Permita pop-ups para generar el PDF.");
        return;
      }
      w.document.open();
      w.document.write(htmlPrint);
      w.document.close();

      // Cerrar acordeón 4 en pantalla
      toggleAccordion("accDetalle", false);
    });

    $("btnGenerarPorAprendiz").addEventListener("click", () => {
      hideAlert();

      if(!state.instructor || !state.ambiente){
        showAlert("Faltan los datos iniciales (Instructor y Ambiente). Recargue la página o diligéncielos nuevamente.");
        return;
      }
      const selKeys = Object.keys(state.seleccion);
      if(selKeys.length === 0){
        showAlert("No hay aprendices seleccionados.");
        return;
      }

      const mapApr = getAprMap();
      const fecha = state.fechaHoy || todayDDMMYYYY();

      for(let i = 0; i < selKeys.length; i++){
        const key = selKeys[i];
        const ap = mapApr[key];
        if(!ap) continue;
        const pages = buildPagesForApr(key, mapApr);
        if(!pages) continue;

        const fileTitle = `Llamado de atencion_${ap.nombre || "Aprendiz"}_${fecha}`;
        const htmlPrint = `<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>${escapeHtml(fileTitle)}</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>${getPrintCss()}</style>
</head>
<body>
  ${pages}
  <script>
    window.addEventListener("load", () => setTimeout(() => window.print(), 600));
  <\/script>
</body>
</html>`;

        const w = window.open("", `_blank_${key}_${i}`);
        if(!w){
          showAlert("El navegador bloqueó una ventana emergente. Permita pop-ups para generar los PDFs por aprendiz.");
          return;
        }
        w.document.open();
        w.document.write(htmlPrint);
        w.document.close();
      }

      toggleAccordion("accDetalle", false);
    });

    function getPrintCss(){
      return `
@page { size: A4; margin: 12mm; }
*{ box-sizing:border-box; }
body{ margin:0; font-family: Inter, Arial, sans-serif; color:#000; }
.pdf-page{
  width: 186mm;
  min-height: 273mm;
  height: auto;
  page-break-after: always;
  overflow: visible;
}
.pdf-page:last-child{ page-break-after:auto; }
.pdf-header{ text-align:justify; padding-top:2mm; }
.pdf-logo{ height:12mm; width:auto; display:block; margin:0 auto 4mm auto; }
.pdf-center{ font-size:12px; font-weight:700; line-height:1.15; margin-bottom:4mm; text-align:center; display:block; width:100%; }
.pdf-title{ font-size:10px; font-weight:900; letter-spacing:0.02em; margin:0 0 6mm 0; text-transform:uppercase; }
.pdf-fields{ font-size:11.5px; line-height:1.25; margin-bottom:5mm; display:flex; flex-direction:column; gap:2mm; }
    .pdf-fields .rowline{ display:flex; flex-wrap:wrap; gap:8mm; margin-bottom:2mm; }
    .pdf-fields .rowline > div{ flex:1; min-width:80mm; }
    .pdf-fields .rowline.rowline--header{
      flex-wrap:nowrap;
      gap:5mm;
      align-items:flex-start;
    }
    .pdf-fields .rowline.rowline--header > div{
      min-width:auto;
      flex:1;
    }
    .pdf-fields .rowline.rowline--header .rowline-date{
      flex:0 0 auto;
      min-width:120px;
      text-align:right;
    }
    .pdf-fields .rowline.rowline--header .rowline-group{
      flex:2 1 60%;
    }
    .pdf-fields .rowline.rowline--header .rowline-place{
      flex:1 1 25%;
    }
    .pdf-fields .rowline.rowline--names > div{
      flex:1 1 100%;
    }
.pdf-fields strong{ font-weight:900; }
.pdf-section-title{ font-size:12px; font-weight:900; margin:0 0 1mm 0; text-transform:uppercase; }
.pdf-text{ font-size:10.8px; line-height:1.35; white-space:pre-wrap; margin-top:2mm; }
.pdf-text.motivo,
.pdf-text.plan{ margin-top:1mm; }
    .pdf-text.obs{
      margin-top:4mm;
      max-height:calc(2 * 1.35em);
      overflow:hidden;
      border:1px solid #111;
      border-radius:6px;
      padding:30px;
      background:#fff;
    }
.pdf-instructor .rowline{ margin-bottom:0; }
    .pdf-sign{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:2mm;
      margin-top:4mm;
      font-size:10.5px;
    }
    .sigline{
      border-top:1px solid #000;
      padding-top:1mm;
      margin-top:7mm;
      min-height:12mm;
    }
    .siglabel{
      font-weight:900;
      text-transform:uppercase;
      font-size:10px;
    }
    .sigmeta{
      font-size:10.3px;
      margin-top:1.5mm;
    }
    .sig-instructor{ grid-column:1; }
    .sig-coordinator{ grid-column:1; grid-row:2; }
    .sig-aprendiz{ grid-column:2; }
    .sig-subdirector{ grid-column:2; grid-row:2; }
    .pdf-page.font-many .sigline{
      margin-top:15mm;
    }
    .pdf-page.font-many .pdf-sign{
      gap:10mm;
      margin-top:12mm;
    }
    .sig-subdirector{ grid-column:2; grid-row:2; }
.pdf-page.dense .pdf-text{ font-size:9.3px; line-height:1.2; }
.pdf-page.font-tiny .pdf-text.motivo,
.pdf-page.font-tiny .pdf-text.plan{ font-size:7px; line-height:1.05; }
.pdf-page.font-many,
.pdf-page.font-many .pdf-text,
.pdf-page.font-many .pdf-fields,
.pdf-page.font-many .pdf-section-title{
  font-size:13px;
}

      `;
    }

    function buildPdfPageHtml(ap, apKey, reasonsOverride){
      if(!ap) return "";
      ensureDetalle(apKey);

      const reasons = Array.isArray(reasonsOverride) && reasonsOverride.length
        ? reasonsOverride
        : Object.entries(state.seleccion[apKey] || {}).filter(([_,v]) => v).map(([rk]) => rk);
      const motivoText = buildMotivoText(apKey, reasons);
      const planText = buildPlanText(apKey, reasons);

      const grupo = state.groupName ? state.groupName : "N/A";
      const lugar = state.ambiente || "N/A";
      const fecha = state.fechaHoy || todayDDMMYYYY();
      const fechaIso = state.fechaHoyIso || todayISO();
      const fechaLong = formatLongDateFromIso(todayISO());
      const doc = ap.documento || "N/A";

      const observaciones = state.detalle[apKey].observaciones || "";

      const isDense = (state.genMode === "one" && reasons.length > 1);
      const isTinyFont = (state.genMode === "one" && reasons.length > 2);
      const isManyMode = state.genMode === "many";
      const pageClasses = ["pdf-page"];
      if(isDense) pageClasses.push("dense");
      if(isTinyFont) pageClasses.push("font-tiny");
      if(isManyMode) pageClasses.push("font-many");
      const pageClass = pageClasses.join(" ");

      return `
<div class="${pageClass}">
  <div class="pdf-header">
    <img class="pdf-logo" src="https://www.sena.edu.co/Style%20Library/alayout/images/logoSena.png" alt="Logo SENA">
    <div class="pdf-center">Centro Comercio y Servicios<br>Regional Tolima<br>LLAMADO DE ATENCION</div>
  </div>
  <div class="pdf-fields">
    <div class="rowline rowline--header">
      <div class="rowline-group"><strong>GRUPO:</strong> ${escapeHtml(grupo)}</div>
      <div class="rowline-place"><strong>LUGAR:</strong> ${escapeHtml(lugar)}</div>
      <div class="rowline-date"><strong>Fecha:</strong> ${escapeHtml(fechaLong)}</div>
    </div>
    <div class="rowline rowline--names">
      <div><strong>NOMBRES Y APELLIDOS:</strong> ${escapeHtml(ap.nombre)} &nbsp;&nbsp; <strong>Documento:</strong> ${escapeHtml(doc)}</div>
    </div>
  </div>

  <div class="pdf-section-title">MOTIVO:</div>
  <div class="pdf-text motivo">${escapeHtml(motivoText)}</div>

  <div class="pdf-fields pdf-instructor" style="margin-top:2mm;">
    <div class="rowline">
      <div><strong>INSTRUCTOR QUE HACE EL LLAMADO:</strong> ${escapeHtml(state.instructor || "")}</div>
    </div>
  </div>

  <div style="margin-top:5mm;">
    <div class="pdf-section-title">Plan de Mejoramiento:</div>
    <div class="pdf-text plan">${escapeHtml(planText)}</div>
  </div>

  <div style="margin-top:5mm;">
    <div class="pdf-section-title">OBSERVACIONES QUE HACE EL APRENDIZ</div>
    <div class="pdf-text obs">${escapeHtml(observaciones)}</div>
  </div>

  <div class="pdf-sign">
    <div class="sigline sig-instructor">
      <div class="siglabel" style="text-align:center;">PRIMER LLAMADO INSTRUCTOR</div>
      <div class="sigmeta" style="text-align:center;">${escapeHtml(state.instructor || "")}</div>
    </div>
    <div class="sigline sig-aprendiz">
            <div class="siglabel" style="text-align:center;">APRENDIZ</div>
      <div class="sigmeta" style="text-align:center;"><strong>${escapeHtml(ap.nombre || "")} ${escapeHtml(doc)}</strong></div>
    </div>
    <div class="sigline sig-coordinator">
      <div class="siglabel">SEGUNDO LLAMADO COORDINADOR ACADÉMICO</div>
    </div>
    <div class="sigline sig-subdirector">
      <div class="siglabel">TERCER LLAMADO SUBDIRECTOR – COMITÉ EVALUACIÓN</div>
    </div>
  </div>
  </div>`;
    }

    function buildPagesForApr(apKey, mapApr){
      const ap = mapApr[apKey];
      if(!ap) return "";
      const reasons = Object.entries(state.seleccion[apKey] || {})
        .filter(([_,v]) => v)
        .map(([rk]) => rk);

      if(state.genMode === "many"){
        return reasons.map(rk => buildPdfPageHtml(ap, apKey, [rk])).join("");
      }
      return buildPdfPageHtml(ap, apKey);
    }

    function defaultMotivoBody(apKey, reasonKey){
      const d = state.detalle[apKey] || {};
      if(reasonKey === "uniforme"){
        return NORMATIVOS.uniforme;
      }
      if(reasonKey === "plagio"){
        return NORMATIVOS.plagio;
      }
      if(reasonKey === "tarde"){
        const dt = d.lateDt ? formatDateTimeLocal(d.lateDt) : "";
        const extras = (d.lateEntries || [])
          .map(formatDateTimeLocal)
          .filter(v => v && v !== dt);
        let text = `${NORMATIVOS.tarde}`;
        if(dt) text += `\nDía y hora: ${dt}`;
        if(extras.length) text += `\nOtros días y horas: ${extras.join(", ")}`;
        return text;
      }
      if(reasonKey === "inasistencias"){
        const dias = (d.inasistencias || []).map(toDDMMYYYY).join(", ");
        return `${NORMATIVOS.inasistencias}${dias ? `\nDías de inasistencia: ${dias}` : ""}`;
      }
      if(reasonKey === "noEvidencias"){
        const evid = (d.evidencias || "").trim();
        return `${NORMATIVOS.noEvidencias}${evid ? `\nNombre evidencias: ${evid}` : ""}`;
      }
      return "";
    }

    function buildMotivoText(apKey, reasons){
      const d = state.detalle[apKey] || {};
      const parts = [];

      function pushSection(title, reasonKey, fallback){
        const body = (d.motivoOverride?.[reasonKey] ?? "").toString().trim();
        const finalBody = body ? body : (fallback || "");
        if(finalBody) parts.push(`${title}:\n${finalBody}`);
      }

      if(reasons.includes("uniforme")){
        pushSection("UNIFORME", "uniforme", defaultMotivoBody(apKey, "uniforme"));
      }
      if(reasons.includes("tarde")){
        pushSection("LLEGADAS TARDE", "tarde", defaultMotivoBody(apKey, "tarde"));
      }
      if(reasons.includes("inasistencias")){
        pushSection("INASISTENCIAS", "inasistencias", defaultMotivoBody(apKey, "inasistencias"));
      }
      if(reasons.includes("noEvidencias")){
        pushSection("NO ENTREGA DE EVIDENCIAS", "noEvidencias", defaultMotivoBody(apKey, "noEvidencias"));
      }
      if(reasons.includes("plagio")){
        pushSection("PLAGIO O FRAUDE", "plagio", defaultMotivoBody(apKey, "plagio"));
      }
      if(reasons.includes("actitudinal")){
        const m = (d.custom?.actitudinal?.motivo || "").trim();
        parts.push(`ACTITUDINAL:\n${m || "(Sin descripción adicional)"}`);
      }
      if(reasons.includes("otro")){
        const m = (d.custom?.otro?.motivo || "").trim();
        parts.push(`OTRO:\n${m || "(Sin descripción adicional)"}`);
      }

      return parts.join("\n\n");
    }

    function buildPlanText(apKey, reasons){
      const d = state.detalle[apKey] || {};
      const parts = [];

      if(reasons.includes("uniforme")){
        parts.push(`UNIFORME:\n${d.planOverride?.uniforme || PLAN_BASE.uniforme}`);
      }
      if(reasons.includes("tarde")){
        parts.push(`LLEGADAS TARDE:\n${d.planOverride?.tarde || PLAN_BASE.tarde}`);
      }
      if(reasons.includes("inasistencias")){
        parts.push(`INASISTENCIAS:\n${d.planOverride?.inasistencias || PLAN_BASE.inasistencias}`);
      }
      if(reasons.includes("noEvidencias")){
        const plan = d.planOverride?.noEvidencias || PLAN_BASE.noEvidencias(d.noEntregaFecha ? toDDMMYYYY(d.noEntregaFecha) : "dd/mm/yyyy");
        parts.push(`NO ENTREGA DE EVIDENCIAS:\n${plan}`);
      }
      if(reasons.includes("plagio")){
        parts.push(`PLAGIO O FRAUDE:\n${d.planOverride?.plagio || PLAN_BASE.plagio}`);
      }
      if(reasons.includes("actitudinal")){
        const p = (d.custom?.actitudinal?.plan || "").trim();
        parts.push(`ACTITUDINAL:\n${p || "(Sin plan adicional)"}`);
      }
      if(reasons.includes("otro")){
        const p = (d.custom?.otro?.plan || "").trim();
        parts.push(`OTRO:\n${p || "(Sin plan adicional)"}`);
      }

      return parts.join("\n\n");
    }

    function formatDateTimeLocal(value){
      // value: yyyy-mm-ddThh:mm
      if(!value) return "";
      const [date, time] = value.split("T");
      if(!date) return value;
      const ddmmy = toDDMMYYYY(date);
      return time ? `${ddmmy} ${time}` : ddmmy;
    }

    initProject();

  </script>
</body>
</html>

